"use client";
import {
  Dialog,
  DialogBackdrop,
  DialogPanel,
  DialogTitle,
} from "@headlessui/react";
import { GoPlusCircle } from "react-icons/go";
import { ChangeEvent, useState, useEffect } from "react";
import { FaMapMarkerAlt } from "react-icons/fa";
import { useGetCountiesQuery } from "@/redux/queries/addreses/counties/countiesApi";
import { useGetSubCountiesQuery } from "@/redux/queries/addreses/subcounties/subCountiesApi";
import { useGetPickupStationsQuery } from "@/redux/queries/addreses/pickupStations/pickupStationsApi";
import { FaChevronDown } from "react-icons/fa";
import { VscChevronDown } from "react-icons/vsc";
import { GoPlus } from "react-icons/go";
import { AiOutlineShop } from "react-icons/ai";
import { MdOutlineCall } from "react-icons/md";
import { LuClock3 } from "react-icons/lu";
import { useGetWardsQuery } from "@/redux/queries/addreses/wards/wardsApi";
import { zodResolver } from "@hookform/resolvers/zod";
import { FieldValues, useForm, Controller } from "react-hook-form";
import { z, ZodType } from "zod";

interface County {
  id: number;
  created: string;
  modified: string;
  name: string;
}
interface SubCounty {
  id: number;
  created: string;
  modified: string;
  name: string;
  county: number;
  county_name: string;
}
interface Ward {
  id: number;
  county_name: string;
  sub_county_name: string;
  created: string;
  modified: string;
  name: string;
  sub_county: number;
}
interface PickupStation {
  id: number;
  county_name: string;
  sub_county_name: string;
  ward_name: string;
  created: string;
  modified: string;
  name: string;
  town: string;
  country: string;
  description: string;
  phone_number: string;
  station_type: string;
  county: number;
  sub_county: number;
  ward: number;
}
interface Outlet {
  id: number;
  county_name: string;
  sub_county_name: string;
  ward_name: string;
  created: string;
  modified: string;
  name: string;
  town: string;
  country: string;
  description: string;
  phone_number: string;
  station_type: string;
  county: number;
  sub_county: number;
  ward: number;
}
export const NewAddress = () => {
  const [isOpen, setIsOpen] = useState(false);
  const [textValue, setTextValue] = useState<string>("");
  const [charCount, setCharCount] = useState<number>(0);

  const [selectedCounty, setSelectedCounty] = useState<County | null>(null);
  const [showCountiesDropdown, setShowCountiesDropdown] =
    useState<boolean>(false);
  const [showSubCountiesDropdown, setShowSubCountiesDropdown] =
    useState<boolean>(false);
  const [showWardsDropdown, setShowWardsDropdown] = useState<boolean>(false);
  const [selectedSubCounty, setSelectedSubCounty] = useState<SubCounty | null>(
    null
  );
  const [selectedWard, setSelectedWard] = useState<Ward | null>(null);
  const [selectedStation, setSelectedStation] = useState<PickupStation | null>(
    null
  );
  const [gridLayout, setGridLayout] = useState<string>("grid-cols-1");
  const [showStations, setShowStations] = useState<boolean>(false);
  const [selectedOption, setSelectedOption] = useState<string>("doorDelivery");
  const [selectedOutlet, setSelectedOutlet] = useState<Outlet | null>(null);
  console.log(selectedStation);
  const {
    isLoading: isLoadingCounties,
    data: countiesData,
    refetch: refetchCounties,
  } = useGetCountiesQuery({}, { refetchOnMountOrArgChange: true });

  const {
    isLoading: isLoadingSubcounties,
    data: subCountiesData,
    refetch: refetchSubcounties,
  } = useGetSubCountiesQuery(
    selectedCounty ? { county__name: selectedCounty.name } : {},
    { skip: !selectedCounty }
  );
  const {
    isLoading: isLoadingWards,
    data: wardsData,
    refetch: refetchWards,
  } = useGetWardsQuery(
    selectedSubCounty ? { sub_county__name: selectedSubCounty?.name } : {},
    { skip: !selectedSubCounty }
  );

  const {
    isLoading: isLoadingPickupStations,
    data: pickupStationsData,
    refetch: refetchStations,
  } = useGetPickupStationsQuery(
    selectedOption === "pickBySelf"
      ? { station_type: "Shop" }
      : selectedWard
      ? { ward__name: selectedWard?.name }
      : {},
    { skip: !selectedWard }
  );

  const handleCountySelect = (county: County) => {
    setSelectedCounty(county);
    setShowCountiesDropdown(false);
    setSelectedSubCounty(null);
  };

  const handleSubCountySelect = (subCounty: SubCounty) => {
    setSelectedSubCounty(subCounty);
    setShowSubCountiesDropdown(false);
  };
  const handleWardSelect = (ward: Ward) => {
    setSelectedWard(ward);
    setShowWardsDropdown(false);
    if (pickupStationsData && pickupStationsData.length > 0) {
      setShowStations(true);
      setGridLayout("grid-cols-4");
    }
  };
  const handleStationSelect = (station: any) => {
    setSelectedStation(station);
    setShowStations(false);
    setGridLayout("grid-cols-1");
  };

  const selectedSubCountyName = selectedSubCounty?.name || "";
  const selectedWardName = selectedWard?.name || "";
  const selectedCountyName = selectedCounty?.name || "";

  const handlePickupStationClick = () => {
    if (pickupStationsData && pickupStationsData.length > 0) {
      setShowStations((prev) => {
        const newShowStations = !prev;
        setGridLayout(newShowStations ? "grid-cols-4" : "grid-cols-1");
        return newShowStations;
      });
    }
  };
  const handleOptionSelect = (option: string) => {
    setSelectedOption(option);
    setShowStations(false);
    setGridLayout("grid-cols-1");

    if (option === "pickupStation" && selectedWard) {
      refetchStations();
    } else if (option === "pickBySelf" && selectedWard) {
      refetchStations();
    }
  };
  const filteredStations = pickupStationsData?.filter(
    (station: PickupStation) =>
      station.station_type === "Shop" && station.ward === selectedWard?.id
  );
  // console.log("filteredStations", filteredStations);
  const handlePickBySelfClick = () => {
    setSelectedOption("pickBySelf");

    if (filteredStations?.length > 0) {
      setShowStations((prev) => {
        const newShowStations = !prev;
        setGridLayout(newShowStations ? "grid-cols-4" : "grid-cols-1");
        return newShowStations;
      });
    } else {
      setShowStations(false);
      setGridLayout("grid-cols-1");
    }
  };
  const addressSchema = z.object({
    name: z.string().min(1, "Name is required"),
    phone_number: z.string().min(10, "Phone number is required"),
    county: z.string().min(1, "County is required"),
    subCounty: z.string().min(1, "Sub-county is required"),
    ward: z.string().min(1, "Ward is required"),
    station: z.string().optional(),
    addressDetails: z.string().optional(),
  });
  const {
    register,
    handleSubmit,
    control,
    formState: { errors },
  } = useForm({
    resolver: zodResolver(addressSchema),
  });
  const handleTextChange = (e: ChangeEvent<HTMLTextAreaElement>): void => {
    const value = e.target.value;
    const currentCharCount = value.length;

    if (currentCharCount <= 200) {
      setTextValue(value);
      setCharCount(currentCharCount);
    }
  };
  const onSubmit = (data: FieldValues) => {
    console.log("Form Data: ", data);

  };
  return (
    <>
      <div
        onClick={() => setIsOpen(true)}
        className="flex items-center bg-red-500 p-2 cursor-pointer rounded-md space-x-2"
      >
        <GoPlus color="white" />
        <h2 className="text-white text-xs font-semibold">Add New address</h2>
      </div>

      <Dialog
        open={isOpen}
        onClose={() => setIsOpen(false)}
        className="relative z-50 top-[40px]"
      >
        <DialogBackdrop
          transition
          className="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"
        />

        <div className="fixed inset-0 z-10 flex items-center justify-center  overflow-y-auto">
          <DialogPanel
            transition
            className="relative max-h-[95vh] w-full max-w-[980px] overflow-y-auto  bg-white text-left shadow-xl transition-all sm:my-8"
          >
            {/* Main div */}
            <form onSubmit={handleSubmit(onSubmit)}>
            <div className={`grid ${gridLayout}`}>
              {/* counties, subcounties, wards */}
              <div className="col-span-2">
                <div className="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                  <div className="flex flex-col gap-3">
                    <div className="flex items-center space-x-4">
                      <div className="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-green-100 sm:mx-0 sm:h-10 sm:w-10">
                        <FaMapMarkerAlt
                          aria-hidden="true"
                          className="h-6 w-6 text-green-900"
                        />
                      </div>
                      <DialogTitle
                        as="h3"
                        className="text-base font-semibold  borer-b leading-6 text-gray-900"
                      >
                        Add address
                      </DialogTitle>
                    </div>
                    
                    <div className="grid grid-cols-2 gap-5">

                      <input
                        placeholder="Enter name"
                        {...register("name")}
                        className="h-[50px] bg-white w-full px-2 border-gray-300 focus:outline-none focus:bg-white focus:shadow-sm border-[1px] rounded-sm placeholder-gray-300 placeholder-text-[10px]"
                      />

                      {errors.name && (
                        <p className="text-red-500">
                          {String(errors.name.message)}
                        </p>
                      )}
                      <input
                        placeholder="Enter phone e.g 07xxxxxxx"
                        {...register("phone")}
                        className="h-[50px] bg-white w-full  px-2 border-gray-300 focus:outline-none focus:bg-white focus:shadow-sm border-[1px] rounded-sm placeholder-gray-300 placeholder-text-xs"
                      />
                      {errors.phone_number && (
                        <p className="text-red-500">
                          {String(errors.phone_number.message)}
                        </p>
                      )}
                    </div>
                    <div className="w-full relative">
                      <input
                        placeholder="county"
                        value={selectedCountyName}
                        onClick={() =>
                          setShowCountiesDropdown(!showCountiesDropdown)
                        }
                        className="h-[50px] bg-white w-full  px-2 border-gray-300 focus:outline-none focus:bg-white focus:shadow-sm border-[1px] rounded-sm placeholder-gray-300 placeholder-text-xs"
                      />
                      <span className="absolute inset-y-0 text-center right-0 flex items-center pr-3 pointer-events-none">
                        <VscChevronDown className="text-gray-400 h-4 w-4" />
                      </span>
                      {showCountiesDropdown && (
                        <div className="absolute min-h-[30vh] max-h-[20vh] overflow-y-scroll w-full bg-white border rounded-md shadow-sm-2 z-[9] p-4">
                          {countiesData?.map((county: County) => (
                            <div
                              className="w-full p-3 hover:bg-slate-100 cursor-pointer"
                              key={county.id}
                              onClick={() => handleCountySelect(county)}
                            >
                              <h1>{county.name}</h1>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                    <div className="w-full relative">
                      <input
                        placeholder="subCounty/Town"
                        className="h-[50px] bg-white w-full px-2 border-gray-300 focus:outline-none focus:bg-white focus:shadow-sm border-[1px] rounded-sm placeholder-gray-300 placeholder-text-xs"
                        value={selectedSubCountyName}
                        onClick={() =>
                          setShowSubCountiesDropdown(!showSubCountiesDropdown)
                        }
                      />
                      <span className="absolute inset-y-0 text-center right-0 flex items-center pr-3 pointer-events-none">
                        <VscChevronDown className="text-gray-400 h-4 w-4" />
                      </span>
                      {showSubCountiesDropdown && (
                        <div className="absolute min-h-[30vh] max-h-[20vh] overflow-y-scroll w-full bg-white border rounded-md shadow-sm-2 z-[9] p-4">
                          {subCountiesData?.map((subCounty: SubCounty) => (
                            <div
                              className="w-full p-3 hover:bg-slate-100 cursor-pointer"
                              key={subCounty.id}
                              onClick={() => {
                                handleSubCountySelect(subCounty);
                              }}
                            >
                              <h1>{subCounty.name}</h1>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                    <div className="w-full relative">
                      <input
                        placeholder="ward"
                        className="h-[50px] bg-white w-full px-2 border-gray-300 focus:outline-none focus:bg-white focus:shadow-sm border-[1px] rounded-sm placeholder-gray-300 placeholder-text-xs"
                        value={selectedWardName}
                        onClick={() => setShowWardsDropdown(!showWardsDropdown)}
                      />
                      <span className="absolute inset-y-0 text-center right-0 flex items-center pr-3 pointer-events-none">
                        <VscChevronDown className="text-gray-400 h-4 w-4" />
                      </span>
                      {showWardsDropdown && (
                        <div className="absolute min-h-[30vh] max-h-[20vh] overflow-y-scroll w-full bg-white border rounded-md shadow-sm-2 z-[9] p-4">
                          {wardsData?.map((ward: Ward) => (
                            <div
                              className="w-full p-3 hover:bg-slate-100 cursor-pointer"
                              key={ward.id}
                              onClick={() => {
                                handleWardSelect(ward);
                              }}
                            >
                              <h1>{ward.name}</h1>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                    <div className="grid  grid-cols-3 gap-5">
                      {/* pickup station option */}

                      <div
                        onClick={() => setSelectedOption("doorDelivery")}
                        className={`p-2 cursor-pointer rounded-md border text-center justify-center ${
                          selectedOption === "doorDelivery"
                            ? "bg-green-100 text-green-900"
                            : "bg-white font-custom border-gray-400"
                        }`}
                      >
                        <h2>Door delivery</h2>
                      </div>
                      <div
                        onClick={handlePickBySelfClick}
                        className={`p-2 cursor-pointer rounded-md border text-center justify-center ${
                          selectedOption === "pickBySelf"
                            ? "bg-blue-100 text-green-900"
                            : "bg-white font-custom border-gray-400"
                        }`}
                      >
                        <h2>Pick By self</h2>
                      </div>
                      {selectedWard &&
                        pickupStationsData &&
                        pickupStationsData.length > 0 && (
                          <div
                            onClick={() => {
                              handlePickupStationClick();
                              setSelectedOption("pickupStation");
                            }}
                            className={`p-2 cursor-pointer rounded-md border text-center justify-center ${
                              selectedOption === "pickupStation"
                                ? "bg-blue-100 text-green-900"
                                : "bg-white font-custom border-gray-400"
                            }`}
                          >
                            <h2>Pickup Station</h2>
                          </div>
                        )}
                    </div>

                    {selectedOption === "pickupStation" &&
                      pickupStationsData?.length > 0 && (
                        <div className="w-full flex flex-col gap-4 p-3 border border-green-900 rounded-sm">
                          <div className="flex items-center justify-between">
                            <h2 className="text-green-900 font-bold text-xl">
                              {selectedStation?.name}
                            </h2>
                            <h2
                              onClick={handlePickupStationClick}
                              className="p-1 text-center bg-green-100 text-green-900 rounded-md cursor-pointer"
                            >
                              change
                            </h2>
                          </div>
                          <h2 className="text-lg font-custom text-green-600">
                            {selectedStation?.county_name}{" "}
                            {selectedStation?.sub_county_name}{" "}
                            {selectedStation?.ward_name}{" "}
                            {selectedStation?.description}
                          </h2>
                        </div>
                      )}
                    {selectedOption === "pickBySelf" &&
                      filteredStations?.length > 0 && (
                        <div className="w-full flex flex-col gap-4 p-3 border border-green-900 rounded-sm">
                          <div className="flex items-center justify-between">
                            <h2 className="text-green-900 font-bold text-xl">
                              {selectedStation?.name}
                            </h2>
                            <h2
                              onClick={handlePickBySelfClick}
                              className="p-1 text-center bg-green-100 text-green-900 rounded-md cursor-pointer"
                            >
                              change
                            </h2>
                          </div>
                          <h2 className="text-lg font-custom text-green-600">
                            {selectedStation?.county_name}{" "}
                            {selectedStation?.sub_county_name}{" "}
                            {selectedStation?.ward_name}{" "}
                            {selectedStation?.description}
                          </h2>
                        </div>
                      )}
                    {selectedOption === "doorDelivery" && (
                      <div className="w-full">
                        <div className="relative w-full min-w-[200px]">
                          <label htmlFor="textarea">
                            Address Details (Delivery to Doorstep)
                          </label>
                          <textarea
                            {...register("addressDetails")}
                            className="peer h-full min-h-[100px] w-full resize-none border border-blue-gray-300  bg-transparent px-3 py-2.5 font-sans text-sm font-normal text-gray-700 outline outline-0 transition-all     focus:border-gray-300  focus:outline-0 placeholder-gray-300 placeholder-text-[10px]"
                            placeholder="Name of the building , floor , Road and ward(E.g Room 13B, 3rd floor , Toll View Apartments, Juja road ,Juja"
                            value={textValue}
                            onChange={handleTextChange}
                            maxLength={200}
                          />
                          {errors.addressDetails && (
                            <p className="text-red-500">
                              {String(errors.addressDetails.message)}
                            </p>
                          )}
                          <div className="text-xs text-gray-500">
                            {charCount}/200 characters
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
                <div className="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                  <button
                    type="submit"
                    // onClick={() => setIsOpen(false)}
                    className="inline-flex w-full justify-center rounded-md bg-green-900 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-900 sm:ml-3 sm:w-auto"
                  >
                    Submit
                  </button>
                  <button
                    type="button"
                    data-autofocus
                    onClick={() => setIsOpen(false)}
                    className="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto"
                  >
                    Cancel
                  </button>
                </div>
              </div>
              {/* stations */}

              {selectedOption === "pickupStation" &&
                pickupStationsData?.length > 0 &&
                showStations && (
                  <div className="col-span-2 flex-row px-6 ">
                    <div className="flex flex-col gap-3">
                      <div className="flex items-center p-3 justify-center">
                        <h2>Choose Pickup Station</h2>
                      </div>
                      <div className="flex flex-col gap-3">
                        {pickupStationsData?.map((station: PickupStation) => (
                          <div
                            onClick={() => handleStationSelect(station)}
                            key={station.id}
                            className="flex flex-col gap-3 border border-gray-300 rounded-md p-3"
                          >
                            <div className="flex flex-col gap-2 border-b p-2">
                              <div className="flex items-center justify-between">
                                <div className="flex items-center space-x-3">
                                  <AiOutlineShop color="gray" />
                                  <h2 className="text-md font-custom font-semibold">
                                    {station.name}
                                  </h2>
                                </div>
                                <div>
                                  <input
                                    type="radio"
                                    className="h-4 w-4 text-blue-500"
                                  />
                                </div>
                              </div>
                              <h2 className="text-xs font-custom ">
                                {" "}
                                {station.description}
                              </h2>
                            </div>
                            <div className="flex flex-col gap-2 p-2">
                              <div className="flex items-center space-x-3">
                                <MdOutlineCall color="gray" />
                                <h2 className="text-xs">
                                  {station.phone_number}
                                </h2>
                              </div>
                              <div className="flex items-center space-x-3">
                                <LuClock3 color="gray" />
                                <h2 className="text-xs">
                                  Mon-Sat: 9:00 - 20:00
                                </h2>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                )}
              {selectedOption === "pickBySelf" &&
                filteredStations?.length > 0 &&
                showStations && (
                  <div className="col-span-2 flex-row px-6">
                    <div className="flex flex-col gap-3">
                      <div className="flex items-center p-3 justify-center">
                        <h2>Choose a Station for Pick By Self</h2>
                      </div>
                      <div className="flex flex-col gap-3">
                        {filteredStations?.length > 0 ? (
                          filteredStations?.map((station: PickupStation) => (
                            <div
                              onClick={() => handleStationSelect(station)}
                              key={station.id}
                              className="flex flex-col gap-3 border border-gray-300 rounded-md p-3"
                            >
                              <div className="flex flex-col gap-2 border-b p-2">
                                <div className="flex items-center justify-between">
                                  <div className="flex items-center space-x-3">
                                    <AiOutlineShop color="gray" />
                                    <h2 className="text-md font-custom font-semibold">
                                      {station.name}
                                    </h2>
                                  </div>
                                  <div>
                                    <input
                                      type="radio"
                                      className="h-4 w-4 text-blue-500"
                                    />
                                  </div>
                                </div>
                                <h2 className="text-xs font-custom ">
                                  {station.description}
                                </h2>
                              </div>
                              <div className="flex flex-col gap-2 p-2">
                                <div className="flex items-center space-x-3">
                                  <MdOutlineCall color="gray" />
                                  <h2 className="text-xs">
                                    {station.phone_number}
                                  </h2>
                                </div>
                                <div className="flex items-center space-x-3">
                                  <LuClock3 color="gray" />
                                  <h2 className="text-xs">
                                    Mon-Sat: 9:00 - 20:00
                                  </h2>
                                </div>
                              </div>
                            </div>
                          ))
                        ) : (
                          <div className="mt-4 text-center">
                            <p className="text-gray-500 text-xs">
                              No stations for pick by self in the selected ward
                            </p>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                )}
            </div>
            </form>
          </DialogPanel>
        </div>
      </Dialog>
    </>
  );
};
